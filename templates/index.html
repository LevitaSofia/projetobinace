<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèóÔ∏è Laborat√≥rio de Trading H√≠brido</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --dark-bg: #0d1117;
            --card-bg: #161b22;
            --border: #30363d;
            --yellow: #fcd535;
            --green: #0ecb81;
            --red: #f6465d;
            --text: #c9d1d9;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            padding: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .card-header-custom {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance-large {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--yellow);
        }

        .profit-positive {
            color: var(--green);
        }

        .profit-negative {
            color: var(--red);
        }

        .strategy-card {
            position: relative;
            transition: all 0.3s ease;
        }

        .strategy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.4);
        }

        .strategy-card.selected {
            border: 2px solid var(--yellow);
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .switch-large {
            transform: scale(1.5);
            margin-left: 10px;
        }

        .live-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .live-indicator.active {
            background-color: var(--green);
            box-shadow: 0 0 10px var(--green);
        }

        .live-indicator.inactive {
            background-color: var(--border);
        }

        .trade-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .trade-item {
            padding: 8px;
            margin: 4px 0;
            background-color: var(--dark-bg);
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center">
                    <i class="fas fa-flask"></i> Laborat√≥rio de Trading H√≠brido
                </h1>
                <p class="text-center text-muted">
                    Testando 3 estrat√©gias simultaneamente | Pre√ßo BTC: $<span id="current-price">0.00</span> |
                    Atualizado: <span id="last-update">--:--:--</span>
                </p>
            </div>
        </div>

        <!-- Real Balance Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header-custom">
                        <span><i class="fas fa-user-circle"></i> Minha Conta Binance</span>
                        <span class="badge bg-info text-dark" id="account-type">CARREGANDO...</span>
                    </div>
                    <div class="row align-items-center">
                        <div class="col-md-4 border-end border-secondary">
                            <h5 class="text-muted mb-1">UID (Identificador)</h5>
                            <h3 class="text-white" id="user-uid">---</h3>
                            <div class="mt-2">
                                <small class="text-muted">Permiss√£o de Trade:</small>
                                <span id="trade-status" class="badge bg-secondary">Verificando...</span>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h5 class="text-muted mb-3">üí∞ Meus Saldos (Carteira Spot)</h5>
                            <div id="balance-list" class="d-flex flex-wrap gap-3">
                                <span class="text-muted">Carregando saldos...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategies Cards -->
        <div class="row">
            <!-- Conservative -->
            <div class="col-md-4">
                <div class="card strategy-card" id="card-conservative">
                    <div class="card-header-custom">
                        <div>
                            <input type="radio" name="strategy" value="conservative" class="radio-custom"
                                onchange="selectStrategy('conservative')">
                            <span class="ms-2">üõ°Ô∏è Conservador</span>
                        </div>
                        <span class="badge bg-secondary">RSI<30 + BB</span>
                    </div>
                    <div class="balance-large" id="balance-conservative">$100.00</div>
                    <div class="mt-2">
                        Lucro: <span id="profit-conservative" class="profit-positive">+0.00%</span>
                    </div>
                    <div class="trade-list mt-3" id="trades-conservative">
                        <div class="text-muted">Aguardando opera√ß√µes...</div>
                    </div>
                </div>
            </div>

            <!-- Aggressive -->
            <div class="col-md-4">
                <div class="card strategy-card" id="card-aggressive">
                    <div class="card-header-custom">
                        <div>
                            <input type="radio" name="strategy" value="aggressive" class="radio-custom"
                                onchange="selectStrategy('aggressive')">
                            <span class="ms-2">üöÄ Agressivo</span>
                        </div>
                        <span class="badge bg-danger">RSI<45 + BB</span>
                    </div>
                    <div class="balance-large" id="balance-aggressive">$100.00</div>
                    <div class="mt-2">
                        Lucro: <span id="profit-aggressive" class="profit-positive">+0.00%</span>
                    </div>
                    <div class="trade-list mt-3" id="trades-aggressive">
                        <div class="text-muted">Aguardando opera√ß√µes...</div>
                    </div>
                </div>
            </div>

            <!-- RSI Pure -->
            <div class="col-md-4">
                <div class="card strategy-card" id="card-rsi_pure">
                    <div class="card-header-custom">
                        <div>
                            <input type="radio" name="strategy" value="rsi_pure" class="radio-custom"
                                onchange="selectStrategy('rsi_pure')">
                            <span class="ms-2">üéØ RSI Puro</span>
                        </div>
                        <span class="badge bg-warning text-dark">RSI<30< /span>
                    </div>
                    <div class="balance-large" id="balance-rsi_pure">$100.00</div>
                    <div class="mt-2">
                        Lucro: <span id="profit-rsi_pure" class="profit-positive">+0.00%</span>
                    </div>
                    <div class="trade-list mt-3" id="trades-rsi_pure">
                        <div class="text-muted">Aguardando opera√ß√µes...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Mode Control -->
        <div class="row">
            <div class="col-12">
                <div class="card text-center">
                    <div class="card-header-custom justify-content-center">
                        <span class="live-indicator" id="live-indicator"></span>
                        <span>MODO DE EXECU√á√ÉO REAL</span>
                        <label class="switch-large">
                            <input type="checkbox" id="live-toggle" onchange="toggleLive()">
                        </label>
                    </div>
                    <p class="text-muted mb-0">
                        ‚ö†Ô∏è Quando ativado, a estrat√©gia selecionada executar√° ordens de verdade na Binance
                    </p>
                </div>
            </div>
        </div>

        <!-- Export Data -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-primary btn-lg" onclick="exportData()">
                    <i class="fas fa-download"></i> Exportar Meus Dados (JSON)
                </button>
                <p class="text-muted mt-2 small">
                    Baixa hist√≥rico de trades, ordens, saldo e informa√ß√µes da conta conforme documenta√ß√£o.
                </p>
            </div>
        </div>
    </div>

    <script>
        async function exportData() {
            try {
                const btn = document.querySelector('button[onclick="exportData()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Baixando...';
                btn.disabled = true;

                const response = await fetch('/api/export_data');
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erro desconhecido');
                }
                
                const data = await response.json();
                
                // Cria blob e link para download
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `binance_data_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('‚úÖ Dados exportados com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar:', error);
                alert('‚ùå Erro ao exportar dados: ' + error.message);
            } finally {
                const btn = document.querySelector('button[onclick="exportData()"]');
                btn.innerHTML = '<i class="fas fa-download"></i> Exportar Meus Dados (JSON)';
                btn.disabled = false;
            }
        }

        async function updateDashboard() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Atualiza pre√ßo e tempo
                document.getElementById('current-price').innerText = data.current_price.toFixed(2);
                document.getElementById('last-update').innerText = data.last_update;

                // --- Atualiza Informa√ß√µes da Conta ---
                if (data.user_info) {
                    document.getElementById('user-uid').innerText = data.user_info.uid;
                    document.getElementById('account-type').innerText = data.user_info.type;
                    
                    const tradeStatus = document.getElementById('trade-status');
                    if (data.user_info.can_trade) {
                        tradeStatus.className = 'badge bg-success';
                        tradeStatus.innerText = 'ATIVO ‚úÖ';
                    } else {
                        tradeStatus.className = 'badge bg-danger';
                        tradeStatus.innerText = 'BLOQUEADO ‚ùå';
                    }

                    // Lista de Saldos
                    const balanceContainer = document.getElementById('balance-list');
                    const balances = data.user_info.balances;
                    
                    if (Object.keys(balances).length > 0) {
                        balanceContainer.innerHTML = Object.entries(balances).map(([asset, amount]) => `
                            <div class="d-flex align-items-center bg-dark p-2 rounded border border-secondary">
                                <div class="me-2 fw-bold text-warning">${asset}</div>
                                <div class="fs-5">${parseFloat(amount).toFixed(8)}</div>
                            </div>
                        `).join('');
                    } else {
                        balanceContainer.innerHTML = '<span class="text-muted">Nenhum saldo encontrado ou erro de conex√£o.</span>';
                    }
                }

                // Atualiza cada estrat√©gia
                for (const [key, strategy] of Object.entries(data.strategies)) {
                    const balance = strategy.balance.toFixed(2);
                    const profit = ((strategy.balance - 100) / 100) * 100;

                    document.getElementById(`balance-${key}`).innerText = `$${balance}`;

                    const profitEl = document.getElementById(`profit-${key}`);
                    profitEl.innerText = `${profit >= 0 ? '+' : ''}${profit.toFixed(2)}%`;
                    profitEl.className = profit >= 0 ? 'profit-positive' : 'profit-negative';

                    // Atualiza trades
                    const tradesContainer = document.getElementById(`trades-${key}`);
                    if (strategy.trades.length > 0) {
                        const lastTrades = strategy.trades.slice(-5).reverse();
                        tradesContainer.innerHTML = lastTrades.map(trade => `
                            <div class="trade-item">
                                <strong>${trade.type}</strong> @ $${trade.price.toFixed(2)}
                                ${trade.profit ? `| ${trade.profit >= 0 ? '+' : ''}$${trade.profit.toFixed(2)}` : ''}
                                <span class="badge bg-secondary">${trade.mode}</span>
                            </div>
                        `).join('');
                    }
                }

                // Marca estrat√©gia selecionada
                document.querySelectorAll('.strategy-card').forEach(card => card.classList.remove('selected'));
                document.getElementById(`card-${data.selected_strategy}`).classList.add('selected');
                document.querySelector(`input[value="${data.selected_strategy}"]`).checked = true;

                // Atualiza indicador live
                const liveIndicator = document.getElementById('live-indicator');
                liveIndicator.className = data.is_live ? 'live-indicator active' : 'live-indicator inactive';
                document.getElementById('live-toggle').checked = data.is_live;

            } catch (error) {
                console.error('Erro ao atualizar:', error);
            }
        }

        async function selectStrategy(strategy) {
            try {
                await fetch('/api/select_strategy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy })
                });
                updateDashboard();
            } catch (error) {
                console.error('Erro ao selecionar estrat√©gia:', error);
            }
        }

        async function toggleLive() {
            const isLive = document.getElementById('live-toggle').checked;
            try {
                const response = await fetch('/api/toggle_live', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_live: isLive })
                });

                if (!response.ok) {
                    alert('Erro: Chaves API n√£o configuradas!');
                    document.getElementById('live-toggle').checked = false;
                }

                updateDashboard();
            } catch (error) {
                console.error('Erro ao alternar modo:', error);
            }
        }

        // Atualiza a cada 2 segundos
        setInterval(updateDashboard, 2000);
        updateDashboard();
    </script>
</body>

</html>